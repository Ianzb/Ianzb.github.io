<body>
    <script>
        function generateImage() {
            const imageInput = document.getElementById('imageInput');
            const textInput = document.getElementById('textInput');
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');

            const image = new Image();
            image.src = URL.createObjectURL(imageInput.files[0]);
            image.onload = async () => {
                canvas.width = image.width;
                canvas.height = image.height;

                ctx.drawImage(image, 0, 0);

                // Load custom font
                const fontInput = document.getElementById('fontInput');
                const customFont = fontInput.files.length > 0
                    ? new FontFace('CustomFont', `url(${URL.createObjectURL(fontInput.files[0])})`)
                    : new FontFace('CustomFont', 'url(./tool/5/汉仪力量黑简.ttf)');
                await customFont.load();
                document.fonts.add(customFont);

                // Load and draw mask image

                // Get input values
                const fontColor = document.getElementById('fontColor').value;
                const strokeColor = document.getElementById('strokeColor').value;
                const shadowColor = document.getElementById('shadowColor').value;
                const fontSizeScale = document.getElementById('fontSizeScale').value;
                const strokeWidth = document.getElementById('strokeWidth').value;
                const bottomMargin = document.getElementById('bottomMargin').value;
                const shadowOffsetX = document.getElementById('shadowOffsetX').value;
                const shadowOffsetY = document.getElementById('shadowOffsetY').value;
                const maskColor = document.getElementById('maskColor').value;

                const fontSize = (canvas.height / 6.5) * fontSizeScale;
                ctx.font = `${fontSize}px CustomFont`;

                // Set text style
                ctx.fillStyle = fontColor;

                // Calculate text position
                const textMetrics = ctx.measureText(textInput.value);
                const textWidth = textMetrics.width;
                const textHeight = textMetrics.actualBoundingBoxAscent;
                const textX = (canvas.width - textWidth) / 2;
                const textY = canvas.height - (canvas.height * bottomMargin) - (textHeight / 5);

                const maskImage = new Image();
                maskImage.src = './tool/5/mask.png';
                await new Promise((resolve) => {
                    maskImage.onload = resolve;
                });


                // Draw red rectangle over the mask area
                const maskHeight = canvas.width * maskImage.height / maskImage.width;
                const maskY = canvas.height - maskHeight;

                // Draw the mask image
                ctx.drawImage(maskImage, 0, maskY, canvas.width, maskHeight);

                // Get the image data of the mask
                const maskImageData = ctx.getImageData(0, maskY, canvas.width, maskHeight + 1);
                const maskData = maskImageData.data;

                for (let i = 0; i < maskData.length; i += 4) {
                    maskData[i] = (maskData[i] * 0.94 + 123) * parseInt(maskColor.slice(1, 3), 16) / 255; // Red
                    maskData[i + 1] = (maskData[i + 1] * 0.94 + 123) * parseInt(maskColor.slice(3, 5), 16) / 255; // Green
                    maskData[i + 2] = (maskData[i + 2] * 0.94 + 123) * parseInt(maskColor.slice(5, 7), 16) / 255; // Blue
                }


                // Put the modified image data back on the canvas
                ctx.putImageData(maskImageData, 0, maskY);

                // Draw shadow
                ctx.fillStyle = shadowColor;
                ctx.fillText(textInput.value, textX + fontSize * shadowOffsetX, textY + fontSize * shadowOffsetY);

                // Set stroke style
                ctx.strokeStyle = strokeColor;
                ctx.lineWidth = strokeWidth;
                ctx.strokeText(textInput.value, textX, textY);

                // Draw text
                ctx.fillStyle = fontColor;
                ctx.fillText(textInput.value, textX, textY);

                const imgData = canvas.toDataURL('image/png');

                // Set the src of the specified img element to the generated image data
                const imgElement = document.getElementById('myImage');
                imgElement.src = imgData;
            };
        }


    </script>
    <div class="sticky-top" id="header"></div>
    <h3 class="zb"><img height="30" src="./svg/tool.svg" width="25">我的世界中国版风格头像制作</h3>
    <div class="zb">
        <div class="row">
            <div class="col">
                <div class="input-group mb-3">
                    <div class="input-group-prepend">
                        <span class="input-group-text">头像图片</span>
                    </div>
                    <input type="file" class="form-control" id="imageInput" accept="image/*">
                </div>
            </div>
            <div class="col">
                <div class="input-group mb-3">
                    <div class="input-group-prepend">
                        <span class="input-group-text">输入文本</span>
                    </div>
                    <input type="text" class="form-control" id="textInput" placeholder="输入文本" value="贺 新 春">
                </div>
            </div>
            <div class="col">
                <div class="input-group mb-3">
                    <div class="input-group-prepend">
                        <span class="input-group-text">字体</span>
                    </div>
                    <input type="file" class="form-control" id="fontInput" accept=".ttf,.otf">
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col">
                <div class="input-group mb-3">
                    <div class="input-group-prepend">
                        <span class="input-group-text">遮罩颜色</span>
                    </div>
                    <input type="color" class="form-control" id="maskColor" value="#ff780e">
                </div>
            </div>
            <div class="col">
                <div class="input-group mb-3">
                    <div class="input-group-prepend">
                        <span class="input-group-text">字体颜色</span>
                    </div>
                    <input type="color" class="form-control" id="fontColor" value="#ffffff">
                </div>
            </div>
            <div class="col">
                <div class="input-group mb-3">
                    <div class="input-group-prepend">
                        <span class="input-group-text">描边颜色</span>
                    </div>
                    <input type="color" class="form-control" id="strokeColor" value="#c87028">
                </div>
            </div>
            <div class="col">
                <div class="input-group mb-3">
                    <div class="input-group-prepend">
                        <span class="input-group-text">阴影颜色</span>
                    </div>
                    <input type="color" class="form-control" id="shadowColor" value="#5a3210">
                </div>
            </div>

        </div>
        <div class="row">

            <div class="col">
                <div class="input-group mb-3">
                    <div class="input-group-prepend">
                        <span class="input-group-text">字体大小倍率</span>
                    </div>
                    <input type="number" class="form-control" id="fontSizeScale" step="0.1" value="1.0">
                </div>
            </div>
            <div class="col">
                <div class="input-group mb-3">
                    <div class="input-group-prepend">
                        <span class="input-group-text">文本描边粗细</span>
                    </div>
                    <input type="number" class="form-control" id="strokeWidth" step="1" value="5">
                </div>
            </div>
            <div class="col">
                <div class="input-group mb-3">
                    <div class="input-group-prepend">
                        <span class="input-group-text">文本距离底边距离</span>
                    </div>
                    <input type="number" class="form-control" id="bottomMargin" step="0.01" value="0.05">
                </div>
            </div>

        </div>
        <div class="row">


        </div>
        <div class="row">
            <div class="col">
                <div class="input-group mb-3">
                    <div class="input-group-prepend">
                        <span class="input-group-text">阴影X偏移量</span>
                    </div>
                    <input type="number" class="form-control" id="shadowOffsetX" step="0.01" value="-0.1">
                </div>
            </div>
            <div class="col">
                <div class="input-group mb-3">
                    <div class="input-group-prepend">
                        <span class="input-group-text">阴影Y偏移量</span>
                    </div>
                    <input type="number" class="form-control" id="shadowOffsetY" step="0.01" value="0.05">
                </div>
            </div>
        </div>
        <div class="row">


        </div>
        <div class="col">
            <button class="btn btn-primary" type="button" onclick="generateImage()">生成图片</button>
        </div>
    </div>
    <img id="myImage" width="50%"></img>

    <div id="footer"></div>
    <script>loadTemplate()</script>
</body>